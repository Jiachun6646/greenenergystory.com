import React, { useState, useEffect, useCallback } from 'react';
import { Button } from '@/components/ui/button';

const COLORS = ['red', 'orange', 'yellow', 'blue', 'green', 'purple', 'pink', 'black', 'gray'];
const COLOR_NAMES = {
  'red': '红色',
  'orange': '橙色', 
  'yellow': '黄色',
  'blue': '蓝色',
  'green': '绿色',
  'purple': '紫色',
  'pink': '粉色',
  'black': '黑色',
  'gray': '灰色'
};

const ColorWordGame = () => {
  const [gameState, setGameState] = useState('start');
  const [level, setLevel] = useState(1);
  const [score, setScore] = useState(0);
  const [keywordColor, setKeywordColor] = useState('');
  const [keyword, setKeyword] = useState('');
  const [gridWords, setGridWords] = useState([]);
  const [timeLeft, setTimeLeft] = useState(6);
  const [progressWidth, setProgressWidth] = useState('100%');

  const getRandomColor = useCallback((excludeColor = '') => {
    const availableColors = COLORS.filter(color => color !== excludeColor);
    return availableColors[Math.floor(Math.random() * availableColors.length)];
  }, []);

  const setupLevel = useCallback(() => {
    // 随机选择关键词颜色和关键词
    const newKeywordColor = getRandomColor();
    let newKeyword;
    do {
      newKeyword = getRandomColor(newKeywordColor);
    } while (newKeyword === newKeywordColor);

    // 随机生成9宫格词语
    const shuffledWords = [...COLORS]
      .sort(() => 0.5 - Math.random())
      .slice(0, 9)
      .map(color => COLOR_NAMES[color]);

    setKeywordColor(newKeywordColor);
    setKeyword(COLOR_NAMES[newKeyword]);
    setGridWords(shuffledWords);
    
    // 设置倒计时
    const initialTime = 6 - (level * 0.25);
    setTimeLeft(initialTime);
    setProgressWidth('100%');
  }, [level, getRandomColor]);

  useEffect(() => {
    if (gameState === 'playing') {
      const timer = setInterval(() => {
        setTimeLeft(prev => {
          if (prev <= 0) {
            clearInterval(timer);
            setGameState('gameOver');
            return 0;
          }
          setProgressWidth(`${(prev / 6) * 100}%`);
          return prev - 0.1;
        });
      }, 100);

      return () => clearInterval(timer);
    }
  }, [gameState]);

  const startGame = () => {
    setGameState('playing');
    setupLevel();
  };

  const handleGridClick = (clickedWord) => {
    if (gameState !== 'playing') return;

    // 检查是否点击了与关键词颜色匹配的词语
    const isCorrect = COLORS.find(color => 
      COLOR_NAMES[color] === clickedWord
    ) === keywordColor;

    if (isCorrect) {
      if (level === 20) {
        setGameState('won');
      } else {
        setLevel(prev => prev + 1);
        setScore(prev => prev + Math.pow(2, level));
        setupLevel();
      }
    } else {
      setGameState('gameOver');
    }
  };

  const resetGame = () => {
    setGameState('start');
    setLevel(1);
    setScore(0);
  };

  const renderStartScreen = () => (
    <div className="flex flex-col items-center justify-center h-full text-center p-4">
      <h1 style={{
        fontFamily: 'Cooper Black', 
        fontSize: '48px', 
        color: 'blue', 
        fontWeight: 'bold'
      }}>
        Click the Color not the Word
      </h1>
      <p style={{
        fontFamily: 'Microsoft YaHei', 
        fontSize: '20px', 
        color: 'black',
        marginTop: '20px'
      }}>
        20 levels. Increasing distractions. Against the clock.
      </p>
      <p style={{
        fontFamily: 'Microsoft YaHei', 
        fontSize: '20px', 
        color: 'black',
        marginTop: '10px'
      }}>
        All you have to do: click the colour and not the word
      </p>
      <Button 
        onClick={startGame}
        className="mt-10 px-8 py-4 rounded-lg"
        style={{
          backgroundColor: '#87CEFA',
          color: 'white',
          fontFamily: 'Microsoft YaHei'
        }}
      >
        START PLAY
      </Button>
    </div>
  );

  const renderGameScreen = () => (
    <div className="flex flex-col h-full">
      {/* 进度条 */}
      <div 
        className="h-2 bg-blue-500" 
        style={{ width: progressWidth }}
      />

      {/* 关键词 */}
      <div 
        className="text-center mt-10 font-bold"
        style={{
          fontFamily: 'Microsoft YaHei', 
          fontSize: '48px', 
          color: keywordColor
        }}
      >
        {keyword}
      </div>

      {/* 九宫格 */}
      <div className="grid grid-cols-3 gap-4 p-4 flex-grow">
        {gridWords.map((word, index) => (
          <button 
            key={index}
            onClick={() => handleGridClick(word)}
            className="border-2 border-blue-300 rounded-lg flex items-center justify-center"
            style={{
              fontFamily: 'Microsoft YaHei', 
              fontSize: '32px', 
              color: 'black'
            }}
          >
            {word}
          </button>
        ))}
      </div>
    </div>
  );

  const renderGameOverScreen = () => (
    <div className="flex flex-col items-center justify-center h-full text-center">
      <p 
        style={{
          fontFamily: 'Microsoft YaHei', 
          fontSize: '36px', 
          color: 'red'
        }}
      >
        Time is out
      </p>
      <p 
        style={{
          fontFamily: 'Microsoft YaHei', 
          fontSize: '36px', 
          color: 'blue',
          marginTop: '20px'
        }}
      >
        Your Score is {score}
      </p>
      <Button 
        onClick={resetGame}
        className="mt-10 px-8 py-4 rounded-lg"
        style={{
          backgroundColor: '#87CEFA',
          color: 'white',
          fontFamily: 'Microsoft YaHei'
        }}
      >
        Try again
      </Button>
    </div>
  );

  const renderWinScreen = () => (
    <div className="flex items-center justify-center h-full text-center">
      <h1 
        style={{
          fontFamily: 'Cooper Black', 
          fontSize: '48px', 
          color: 'red', 
          fontWeight: 'bold'
        }}
      >
        Congratulations. You made it through all the levels!
      </h1>
    </div>
  );

  return (
    <div className="h-screen w-screen flex flex-col">
      {gameState === 'start' && renderStartScreen()}
      {gameState === 'playing' && renderGameScreen()}
      {gameState === 'gameOver' && renderGameOverScreen()}
      {gameState === 'won' && renderWinScreen()}
    </div>
  );
};

export default ColorWordGame;
